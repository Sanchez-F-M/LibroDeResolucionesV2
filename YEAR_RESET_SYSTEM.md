# üìÖ Sistema de Reset Anual de Numeraci√≥n de Resoluciones

## üìñ √çndice

1. [Descripci√≥n General](#descripci√≥n-general)
2. [Caracter√≠sticas Principales](#caracter√≠sticas-principales)
3. [Arquitectura del Sistema](#arquitectura-del-sistema)
4. [Formato de Numeraci√≥n](#formato-de-numeraci√≥n)
5. [Instalaci√≥n y Configuraci√≥n](#instalaci√≥n-y-configuraci√≥n)
6. [Uso del Sistema](#uso-del-sistema)
7. [Migraci√≥n de Datos Existentes](#migraci√≥n-de-datos-existentes)
8. [Troubleshooting](#troubleshooting)
9. [Preguntas Frecuentes (FAQ)](#preguntas-frecuentes-faq)

---

## Descripci√≥n General

El **Sistema de Reset Anual** implementa una numeraci√≥n autom√°tica de resoluciones con el formato `{n√∫mero}-{a√±o}`, donde el contador se reinicia autom√°ticamente cada 1 de enero a las 00:01 AM, manteniendo todos los datos hist√≥ricos intactos.

### ‚ú® Ejemplo de Funcionamiento

```
A√±o 2024:
- 001-2024
- 002-2024
- ...
- 150-2024

üîÑ 1 de Enero 2025 a las 00:01 AM ‚Üí Reset autom√°tico

A√±o 2025:
- 001-2025  ‚Üê Comienza desde 1 nuevamente
- 002-2025
- ...
```

**Importante:** Las resoluciones de 2024 **permanecen** en la base de datos y son totalmente consultables.

---

## Caracter√≠sticas Principales

### ‚úÖ Reset Autom√°tico Anual

- **Fecha:** Cada 1 de enero a las 00:01 AM
- **Zona horaria:** `America/Argentina/Buenos_Aires` (configurable)
- **Verificaci√≥n:** Job scheduler con `node-cron`
- **Sin intervenci√≥n manual:** El sistema se gestiona autom√°ticamente

### ‚úÖ Preservaci√≥n de Datos Hist√≥ricos

- Ninguna resoluci√≥n se elimina
- Todas las resoluciones mantienen sus im√°genes asociadas
- B√∫squedas funcionan en todos los a√±os
- Integridad referencial garantizada

### ‚úÖ Migraci√≥n Inteligente

- Script idempotente (se puede ejecutar m√∫ltiples veces)
- Backup conceptual antes de migrar
- Detecci√≥n autom√°tica de formatos antiguos
- Rollback autom√°tico en caso de error

### ‚úÖ Compatibilidad con Formatos Antiguos

El sistema reconoce y maneja m√∫ltiples formatos:

- `001-2025` - Formato nuevo est√°ndar
- `123` - Formato legacy (solo n√∫mero)
- `RES-001-2025` - Formato alternativo
- `2025001` - Formato de 7 d√≠gitos

---

## Arquitectura del Sistema

### üìÅ Estructura de Archivos

```
server/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ YearResetService.js      # Servicio principal de reset anual
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ migrate-to-year-format.js # Script de migraci√≥n de datos
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îî‚îÄ‚îÄ postgres-connection.js    # Funciones SQL y base de datos
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ controllers/
‚îÇ       ‚îî‚îÄ‚îÄ book.controller.js    # Controlador actualizado
‚îî‚îÄ‚îÄ index.js                       # Integraci√≥n del job scheduler
```

### üîß Componentes Clave

#### 1. YearResetService (`services/YearResetService.js`)

Servicio singleton que gestiona:

- Obtenci√≥n del a√±o actual
- Generaci√≥n del siguiente n√∫mero
- Verificaci√≥n de cambio de a√±o
- Ejecuci√≥n del reset
- Estad√≠sticas por a√±o

**M√©todos principales:**

```javascript
// Obtener siguiente n√∫mero de resoluci√≥n
await yearResetService.getNextResolutionNumber()
// Retorna: "001-2025"

// Verificar si necesita reset
await yearResetService.checkIfResetNeeded()
// Retorna: true/false

// Ejecutar reset manual
await yearResetService.executeYearReset()

// Obtener estad√≠sticas
await yearResetService.getYearlyStatistics()
```

#### 2. Funciones SQL en PostgreSQL

```sql
-- Funci√≥n para extraer a√±o del n√∫mero de resoluci√≥n
CREATE FUNCTION get_resolution_year(resolution_number VARCHAR)
RETURNS INTEGER

-- √çndice funcional para optimizar b√∫squedas por a√±o
CREATE INDEX idx_resolution_year
ON resolution(get_resolution_year("NumdeResolucion"));
```

#### 3. Job Scheduler (node-cron)

```javascript
// Verificaci√≥n diaria a las 00:01 AM
cron.schedule('1 0 * * *', async () => {
  await yearResetService.periodicCheck();
}, {
  timezone: 'America/Argentina/Buenos_Aires'
});
```

---

## Formato de Numeraci√≥n

### üìã Formato Est√°ndar

```
NNN-YYYY
```

Donde:

- **NNN:** N√∫mero secuencial con padding de 3 d√≠gitos (001, 002, ..., 999)
- **YYYY:** A√±o de 4 d√≠gitos (2024, 2025, etc.)

### üìä Ejemplos

| Resoluci√≥n | Formato  | A√±o  | N√∫mero Secuencial     |
| ---------- | -------- | ---- | --------------------- |
| `001-2025` | Est√°ndar | 2025 | 1                     |
| `050-2024` | Est√°ndar | 2024 | 50                    |
| `123-2025` | Est√°ndar | 2025 | 123                   |
| `001-2026` | Est√°ndar | 2026 | 1 (despu√©s del reset) |

### üîÑ Formatos Compatibles (Legacy)

El sistema **acepta y busca** estos formatos antiguos:

- `123` ‚Üí Se migra a `123-{a√±o_fecha_creacion}`
- `RES-045-2024` ‚Üí Ya tiene formato con a√±o
- `2025001` ‚Üí Formato de 7 d√≠gitos (a√±o + n√∫mero)

---

## Instalaci√≥n y Configuraci√≥n

### 1Ô∏è‚É£ Instalar Dependencias

```bash
cd server
npm install node-cron date-fns-tz
```

### 2Ô∏è‚É£ Configurar Variables de Entorno

Editar `server/.env`:

```env
# Zona horaria para el reset anual
TIMEZONE=America/Argentina/Buenos_Aires

# Hora del d√≠a para ejecutar el reset (formato 24h)
RESET_HOUR=0

# (Opcional) Notificaciones por email
ENABLE_RESET_NOTIFICATIONS=false
ADMIN_EMAIL=admin@example.com
```

### 3Ô∏è‚É£ Inicializar Base de Datos

Las funciones SQL se crean autom√°ticamente al iniciar el servidor por primera vez.

```bash
npm run dev
```

Ver√°s en los logs:

```
‚úÖ Funciones SQL y √≠ndices para a√±o creados
```

### 4Ô∏è‚É£ Ejecutar Migraci√≥n de Datos

**‚ö†Ô∏è IMPORTANTE: Hacer backup antes de migrar en producci√≥n**

```bash
cd server
node scripts/migrate-to-year-format.js
```

Salida esperada:

```
üîÑ INICIANDO MIGRACI√ìN DE DATOS AL FORMATO CON A√ëO
=====================================================
üìä Obteniendo resoluciones existentes...
üì¶ Total de resoluciones encontradas: 25

‚úÖ Migrado: 1 -> 001-2024 (a√±o: 2024)
‚úÖ Migrado: 2 -> 002-2024 (a√±o: 2024)
...

üìä RESUMEN DE MIGRACI√ìN
======================================================
‚úÖ Resoluciones migradas: 25
‚è≠Ô∏è  Resoluciones saltadas: 0
‚ùå Errores: 0
üì¶ Total procesadas: 25
======================================================
```

---

## Uso del Sistema

### üÜï Crear Nueva Resoluci√≥n

El frontend autom√°ticamente obtiene el siguiente n√∫mero:

```javascript
// Solicitud al backend
GET /api/books/last-number

// Respuesta
{
  "lastNumber": "001-2025",
  "format": "NNN-YYYY"
}
```

El usuario ve el n√∫mero sugerido y puede proceder a crear la resoluci√≥n.

### üîç Buscar Resoluciones

Las b√∫squedas son compatibles con todos los formatos:

```javascript
// B√∫squeda por n√∫mero
- "001-2025" ‚Üí Encuentra la resoluci√≥n exacta
- "1" ‚Üí Encuentra "001-2025" y formatos legacy
- "2025" ‚Üí Encuentra todas las resoluciones de 2025
```

### üìä Ver Estad√≠sticas por A√±o

```javascript
// En el backend
const stats = await yearResetService.getYearlyStatistics();

// Retorna:
[
  { year: "2025", count: 15 },
  { year: "2024", count: 150 },
  { year: "2023", count: 200 },
  { year: "legacy", count: 5 }
]
```

---

## Migraci√≥n de Datos Existentes

### üîß Script de Migraci√≥n

El script `migrate-to-year-format.js` es **idempotente** (puede ejecutarse m√∫ltiples veces).

#### Caracter√≠sticas:

- ‚úÖ Detecta resoluciones sin formato de a√±o
- ‚úÖ Usa `FechaCreacion` para determinar el a√±o
- ‚úÖ Actualiza tabla `resolution` e `images`
- ‚úÖ Verifica conflictos antes de migrar
- ‚úÖ Rollback autom√°tico en caso de error
- ‚úÖ Backup conceptual antes de iniciar

#### Ejecuci√≥n Manual:

```bash
# Desde la ra√≠z del proyecto
cd server
node scripts/migrate-to-year-format.js
```

#### Ejecuci√≥n desde C√≥digo:

```javascript
import { migrateResolutionsToYearFormat } from './scripts/migrate-to-year-format.js';

const result = await migrateResolutionsToYearFormat();
console.log(result);
// { success: true, migrated: 25, skipped: 0, errors: 0, total: 25 }
```

### üìã Verificaci√≥n Post-Migraci√≥n

```sql
-- Ver todas las resoluciones con nuevo formato
SELECT "NumdeResolucion", "FechaCreacion"
FROM resolution
WHERE "NumdeResolucion" LIKE '%-%'
ORDER BY "NumdeResolucion";

-- Verificar resoluciones sin migrar
SELECT COUNT(*)
FROM resolution
WHERE "NumdeResolucion" NOT LIKE '%-%'
  AND "NumdeResolucion" !~ '^[0-9]{7}$';
```

---

## Troubleshooting

### ‚ùì Problema: El reset no se ejecut√≥ el 1 de enero

**Posibles causas:**

1. El servidor no estaba corriendo a las 00:01 AM
2. La zona horaria est√° mal configurada
3. El job scheduler no se inicializ√≥

**Soluci√≥n:**

```bash
# 1. Verificar que el servidor est√° corriendo
ps aux | grep node

# 2. Verificar zona horaria en los logs
# Buscar: "üìÖ YearResetService inicializado - Zona horaria: ..."

# 3. Ejecutar reset manual si es necesario
# Crear endpoint temporal o usar el servicio directamente
```

### ‚ùì Problema: N√∫meros duplicados despu√©s del reset

**Causa:** La migraci√≥n no se ejecut√≥ correctamente o hay resoluciones con formato incorrecto.

**Soluci√≥n:**

```bash
# 1. Ejecutar diagn√≥stico
cd server
node -e "import('./services/YearResetService.js').then(m => m.default.getYearlyStatistics().then(console.log))"

# 2. Re-ejecutar migraci√≥n
node scripts/migrate-to-year-format.js

# 3. Verificar integridad
psql -d libro_resoluciones -c "SELECT * FROM resolution WHERE \"NumdeResolucion\" NOT LIKE '%-%'"
```

### ‚ùì Problema: Error "Cannot find module 'node-cron'"

**Soluci√≥n:**

```bash
cd server
npm install node-cron date-fns-tz
```

### ‚ùì Problema: El frontend muestra n√∫meros sin formato

**Causa:** El backend devuelve el formato antiguo o el frontend no est√° actualizado.

**Soluci√≥n:**

```bash
# 1. Verificar respuesta del backend
curl http://localhost:3000/api/books/last-number

# 2. Debe devolver algo como:
# {"lastNumber":"001-2025","format":"NNN-YYYY"}

# 3. Si no, reiniciar el servidor backend
cd server
npm run dev
```

### ‚ùì Problema: Error en migraci√≥n "Transaction rollback"

**Causa:** Conflicto de nombres o error en la base de datos.

**Soluci√≥n:**

```bash
# 1. Ver logs detallados de la migraci√≥n
node scripts/migrate-to-year-format.js 2>&1 | tee migration.log

# 2. Identificar la resoluci√≥n problem√°tica en los logs

# 3. Corregir manualmente si es necesario
psql -d libro_resoluciones
```

---

## Preguntas Frecuentes (FAQ)

### ‚ùì ¬øQu√© pasa si el servidor se reinicia el 1 de enero?

El sistema detecta el cambio de a√±o al iniciar y ejecuta el reset si es necesario.

### ‚ùì ¬øPuedo cambiar la zona horaria despu√©s de implementar?

S√≠, solo edita la variable `TIMEZONE` en `.env` y reinicia el servidor.

### ‚ùì ¬øQu√© pasa con las resoluciones creadas manualmente con formato antiguo?

Se pueden migrar ejecutando el script de migraci√≥n en cualquier momento.

### ‚ùì ¬øEl reset afecta el rendimiento?

No, el reset es instant√°neo ya que solo verifica el a√±o, no modifica datos.

### ‚ùì ¬øPuedo usar un formato diferente como "YYYY-NNN"?

S√≠, puedes modificar el m√©todo `getNextResolutionNumber` en `YearResetService.js`:

```javascript
// Cambiar de NNN-YYYY a YYYY-NNN
return `${currentYear}-${formattedNumber}`;
```

### ‚ùì ¬øC√≥mo hago backup antes de la migraci√≥n en producci√≥n?

```bash
# PostgreSQL
pg_dump -h HOST -U USER -d DATABASE > backup_$(date +%Y%m%d).sql

# Restaurar si es necesario
psql -h HOST -U USER -d DATABASE < backup_YYYYMMDD.sql
```

### ‚ùì ¬øPuedo desactivar el reset autom√°tico?

S√≠, comenta la secci√≥n del cron job en `server/index.js`:

```javascript
// Comentar estas l√≠neas:
// cron.schedule('1 0 * * *', async () => {
//   await yearResetService.periodicCheck();
// }, { timezone: '...' });
```

### ‚ùì ¬øC√≥mo pruebo el reset sin esperar al 1 de enero?

Puedes ejecutar un reset manual desde Node.js:

```javascript
import yearResetService from './services/YearResetService.js';

// Forzar cambio de a√±o
yearResetService.lastCheckedYear = 2024;
await yearResetService.executeYearReset();
```

---

## üìû Soporte

Si encuentras alg√∫n problema no cubierto en esta documentaci√≥n:

1. Revisa los logs del servidor (`server/logs/`)
2. Verifica la configuraci√≥n en `.env`
3. Consulta el c√≥digo fuente con comentarios detallados
4. Crea un issue en el repositorio

---

## üìù Changelog

### v2.0.0 (Octubre 2025)

- ‚ú® Implementaci√≥n inicial del sistema de reset anual
- ‚ú® Servicio `YearResetService` creado
- ‚ú® Script de migraci√≥n de datos
- ‚ú® Job scheduler con node-cron
- ‚ú® Funciones SQL para optimizaci√≥n
- ‚ú® Compatibilidad con formatos legacy
- ‚ú® Documentaci√≥n completa

---

**üéâ ¬°Sistema de Reset Anual implementado exitosamente!**
